---
output:
  word_document:
    fig_caption: yes
    reference_docx: "boot/data/sec_04_template.docx"
    toc: true
bibliography: "boot/data/report_biblio.bib"
csl: "boot/data/ices-journal-of-marine-science.csl"
---



```{r pkgs, echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
library(icesAdvice)
library(flextable)
library(FLCore)
library(officedown)
library(officer)
library(TAF)
library(png)
library(grid)
library(gridExtra)
```


```{r setup, knitr, echo=FALSE, message=FALSE, warning=FALSE}
opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, fig.pos='!hbt',fig.align = 'center' )

# To print the inline numbers using normal notation and not scientific notation.
options(scipen=999)

```


```{r caption_settings}
tabruns.start <- list(
   # run_word_field("STYLEREF 2 \\s"),
   # ftext("."),
  run_autonum(seq_id = "Table", pre_label = "", post_label = "", tnd=3, tns=".", start=1)
)

tabruns <- list(
  run_autonum(seq_id = "Table", pre_label = "", post_label = "", tnd=3, tns=".")
)

figruns.start <- list(
  run_autonum(seq_id = "Figure", pre_label = "", post_label = "", tnd=3, tns=".", start=1)
)

figruns <- list(
  run_autonum(seq_id = "Figure", pre_label = "", post_label = "", tnd=3, tns=".")
)

```

```{r officer_landscape}
op_section <- prop_section(type = "continuous")
close_section <- prop_section(
    page_size = page_size(orient = "landscape"), 
    type = "continuous")

```


```{r load}
run_esc<-"boot/data/run/" 
esc<-readLines(paste0(run_esc,"Esc.txt")) 


path_dat<-paste0("data/run/",esc)
path_mod<-paste0("report/run/",esc)
path_out<-paste0("output/run/",esc)
path_retro<-paste0("report/retro/",esc)
# load
load(paste0(path_mod,"/report.RData"))
load(paste0(path_mod,"/tables_run.RData"))
load(paste0(path_dat,"/inputData.RData"))
load(paste0(path_out,"/output.RData"))
load(paste0(path_retro,"/rho.RData"))
```

```{r}
block_section(op_section) # open section
```


# ane.27.9a stock (Anchovy in ICES Division 9a). Southern component (Anchovy in ICES Subdivision 9a South): Assessment Using Age Composition data.


María José Zúñiga,  Margarita Rincón, Fernando Ramos


## Assessment model

The assessment of the anchovy in ICES division 9a, southern component was performed in Stock Synthesis software, version 3.30.22.1 [SS3, @Methot2024] under the Linux platform. SS3 is a generalized age and/or length-based model that is very flexible with regard to the types of data that may be included, the functional forms that are used for various biological processes, the level of complexity and number of parameters that may be estimated. The model is coded in C++ with parameter estimation enabled by automatic differentiation (www.admb-project.org) and available at the NOAA Fisheries integrated toolbox: https://noaa-fisheries-integrated-toolbox.github.io/SS3. A description and discussion of the model can be found in @Methot2013.

The stock assessment has been performed for the period 1989-2023. The assessment model is a one area, annual with data in quarters, age-based model where the population is comprised of 3+ age-classes (with age 3 representing a plus group) with sexes combined (male and females are modeled together).



## Data

Input data include total catch (in biomass), age composition of the catch (in proportion), abundance (in biomass) and age composition  from an annual *PELAGO*, *ECOCADIZ*, *ECOCADIZ-RECLUTAS* surveys, and spawning-stock biomass (SSB) from triennial DEPM *BOCADEVA* survey. The Figure `r run_reference("fig_input_data")` provides a visual representation of the input data used in the stock assessment model, categorized into three main types: catches, abundance indices, and age compositions. These data are displayed over time (years) and are represented by circles, with the size of each circle reflecting the magnitude of the data.


```{r}
include_graphics(file.path(path_mod,"fig_input_data.png"))
```
Figure `r run_bookmark("fig_input_data", figruns.start)`: ane.27.9a stock. Summarises data input by year, where circle area is relative within a data type. Circles are proportional to total catch for catches, to precision for indices and to total sample size for age compositions.


### Catches

Anchovy catches in the Gulf of Cádiz exhibit seasonality, with 40.61% concentrated in the second quarter (Q2), averaging 2120.26 tons historically, followed by the third quarter (Q3) with 29.60% (1545.23 tons), the first quarter (Q1) with 19.39% (1012.42 tons), and the fourth quarter (Q4) with 10.39% (542.61 tons). In 2023, first-quarter catches were 7.84% lower than the historical average, while second, third, and fourth-quarter catches increased by 71.03%, 48.06%, and 14.70%, respectively (Figure `r run_reference("fig_catches")` and Table `r run_reference("tb_catches")`).


```{r}
include_graphics(file.path(path_mod,"fig_catches.png"))
```
Figure `r run_bookmark("fig_catches", figruns)`: ane.27.9a stock. Quarterly Catch.

\newpage

Table `r run_bookmark("tb_catches", tabruns.start)`:  ane.27.9a stock. Quarterly Catch. 

```{r}
include_graphics(file.path(path_mod,"tb_catches.png"))
```

\newpage

### Abundance indices

The abundance indices *PELAGO*, *ECOCADIZ*, *BOCADEVA*, and *ECOCADIZ-RECLUTAS* exhibit interannual variability over time (Figure `r run_reference("index9_standcpueall")`). *PELAGO*, with data from 1999 to 2023, shows fluctuations with a peak in 2016 at 65,345 tons, followed by a decline, but with a slight recovery in 2023 to 26,786 tons. *ECOCADIZ*, covering the period from 2004 to 2023, reaches its maximum in 2019 at 57,700 tons, followed by a significant decrease to 9,714 tons in 2023. *BOCADEVA*, with data from 2005 to 2023, shows a steady increase to its peak in 2020 at 81,466 tons, followed by a reduction to 15,138 tons in 2023. *ECOCADIZ-RECLUTAS*, recorded from 2014 to 2023, shows a sustained increase until 2019 at 48,398 tons, followed by a decrease to 8,300 tons in 2023. These patterns reflect a high variability in abundance over time with changes, with periods of increase followed by declines in the later years of each series  (Table `r run_reference("tb_index")`).



```{r}
include_graphics(file.path(path_mod,"/fig_indiceBiomass.png"))
```

Figure `r run_bookmark("index9_standcpueall", figruns)`: ane.27.9a stock. Time series of biomass indices for the Gulf of Cádiz anchovy stock, represented by the *PELAGO*, *ECOCADIZ*, *BOCADEVA*, and *ECOCADIZ-RECLUTAS* surveys.


\newpage

Table `r run_bookmark("tb_index", tabruns)`: ane.27.9a stock. Acoustic biomass (ton) by surveys *PELAGO*, *ECOCADIZ*, *BOCADEVA*, and *ECOCADIZ-RECLUTAS*. 

```{r}
include_graphics(file.path(path_mod,"tb_index.png"))
```

\newpage

### Age composition

In the  model, the age proportion of the commercial fleet (*SEINE*) by quarter and year (1989 to 2023) is used (Figure `r run_reference("fig_agecomp_by_quartersSeine")`). It can be observed, that age-0 proportion compared to other ages has been increasing in the last years while age-1 predominates in Q1 and Q2, with a constant proportion over time. Age-0 is not recorded in Q1 and Q2 by convention.  In Q3 and Q4, the proportion of age-1 individuals decreases as the proportion of age-0 increases. Additionaly, ages 2 and 3 exhibit lower and variable proportions across all quarters over the years, without a defined pattern of change.



```{r}
include_graphics(file.path(path_mod,"fig_agecomp_by_quartersSeine.png"))
```

Figure `r run_bookmark("fig_agecomp_by_quartersSeine", figruns)`: ane.27.9a stock. Age proportion of the commercial fleet (*SEINE*) by quarter (1989 to 2023).

\newpage

Figure `r run_reference("fig_agecomp_by_quartersSurveys")` shows the yearly age proportions from surveys *PELAGO*, *ECOCADIZ*, and *ECOCADIZ-RECLUTAS* that were used as input for the model. It can be observed that in the *PELAGO* survey, conducted in the second quarter (Q2), age 1 represents the highest proportion over time, with a presence of ages 2 and 3, and no records of age 0 individuals. The *ECOCADIZ* survey, primarily conducted in the third quarter (Q3), shows a predominance of age 1, with an increase in the proportion of age 0 from 2010 onward; in 2004 and 2006, when the survey was conducted in the second quarter (Q2), no age 0 individuals were recorded by convention. The *ECOCADIZ-RECLUTAS* survey, conducted since 2014 in October (fourth quarter, Q4), shows a higher proportion of age 0, followed by age 1, with lower representation of ages 2 and 3.


```{r}
include_graphics(file.path(path_mod,"fig_agecomp_by_quartersSurveys.png"))
```

Figure `r run_bookmark("fig_agecomp_by_quartersSurveys", figruns)`: ane.27.9a stock. Age proportion by surveys  (*PELAGO*, *ECOCADIZ*, and *ECOCADIZ-RECLUTAS*).

\newpage

### Weigth-at-age

Figure `r run_reference("fig_weight_by_quarters")` presents the age-specific weight-at-age values at the start of each season, estimated from external data sources. The figure illustrates that mean weight differences between age groups remain consistent over time, with some variability observed across quarters. Individuals aged 3 show greater variability in mean weight compared to younger age groups. For further details, refer to the working document by **Zuñiga et al. (2024)**.

```{r}
include_graphics(file.path(path_mod,"fig_weight_by_quarters.png"))
```

Figure `r run_bookmark("fig_weight_by_quarters", figruns)`: ane.27.9a stock. Weight at age by quarters.

### Model setting

#### Natural mortality

Age-specific natural mortality input values at the beginning of the year, which were derived from external data sources. For further details, refer to the working document by **Rincón et al. (2024)**.

```{r}
include_graphics(file.path(path_mod,"tb_natM.png"))
```

#### Maturity

Due to some inconsistencies in the maturity ogives not noticed during WKPELA 2018, we assume that all individuals with age 1 or higher (B1+), are mature i.e. these abundance estimates result equivalent to spawning stock biomass estimates. For further details, refer to the working document by **ICES 2024 and  WD Rincón et al. (2024)**.

```{r}
include_graphics(file.path(path_mod,"tb_maturity.png"))
```


#### Growth

It is not modelled explicitly. 


#### Recruitment

Annual recruitments are defined as parameters and the functional relationship for the spawner-recruitment is such that steepness is ignored and there is no bias adjustment. Standard deviation of log number of recruits was set to 0.6. 

#### Fishing mortality

Fishing mortality is applied as the hybrid method does a Pope´s approximation to provide initial values for iterative adjustment of the continuous F values to closely approximate the observed catch. Total catch biomass by year is assumed to be accurate and precise. The F values are tuned to match this catch. 

#### Catchability

All the surveys are assumed to be relative indices of abundance. The catchability are modelled with a simple $q$ linear model.

#### Selectivity

The fishery selectivity was set as a logistic function fixed over time. <!-- se usan bloques de selectividad--> (**Figure xx**).  In *PELAGO*, *ECOCADIZ*, *ECOCADIZ-RECLUTAS* surveys was set as a logistic function fixed over time (**Figure xx**).

#### Data weighting

Coeficient of variation (CV): A standar error of 0.05 was assumed for all quarters of catches and 0.3 for the *PELAGO*, *ECOCADIZ*, *ECOCADIZ-RECLUTAS* surveys, and spawning-stock biomass (SSB) from triennial DEPM *BOCADEVA* survey, reflecting the accurate sampled catches and the CV level of the surveys. A standard error of 0.3 is assumed for all years for the DEPM index based on the uncertainty of the SSB estimates.

Sample size (nm): The age composition were adjusted assumming a multinomial error structure with variance described by the sample size, set at 100 for both the commercial fleet and acoustic survey. The Francis method TA1.8 [@Francis2011] was selected for age data weighting in catches and surveys data. 


#### Initial population

It is calculated by estimating an initial equilibrium population modified by age composition data in the first year of the assessment [@Methot2013]. The model starts in 1989 and the equilibrium population age structure was assumed to be in an exploited state with an initial catch of 0 tonnes <!-- corresponding to the average catches first 5 years of data (1989-93.)  -->

Variance estimates for all estimated parameters are calculated from the Hessian matrix. Minimisation of the likelihood is implemented in phases using standard ADMB process. The phases in which estimation will begin for each parameter is shown in the control file available in the TAF repository for this stock <!--(https://github.com/ices-taf/2024_ane27.9a_assessment)-->. The R packages r4ss version `r packageVersion("r4ss")`  [@Taylor2021] and ss3diags version `r packageVersion("ss3diags")` [@Carvalho2021] were used to process and view model outputs. All analyses were conduction in `r R.version.string`.


\newpage

A summary of the model key model assumptions and parameters for the Stock Synthesis is available in Table `r run_reference("tb_dat_stru")`.

Table `r run_bookmark("tb_dat_stru", tabruns)`: ane.27.9a stock. Input data type, model assumptions and settings for the assessment  with data series 1989-2023.

```{r}
include_graphics(file.path(path_mod,"tb_dat_stru.png"))
```


\newpage

## Diagnostic

The  model successfully converged, as evidenced by the Hessian matrix being positive definite and the final gradient being relatively small, with a gradient value of `r convergency`. The "Status" column in Table `r run_reference("tb_params_est")` shows that the initial model configuration has allowed for adequate optimization of the parameters. Additionally, the gradient for all parameters is relatively small. It is important to note that the bounds imposed on the initial parameters have not restricted the search for optimized values, as reflected in the "Afterbound" column.


Table `r run_bookmark("tb_params_est", tabruns)`:  ane.27.9a stock. Parameters estimated by the initial base model.

```{r}
include_graphics(file.path(path_mod,"tb_params_est.png"))
```


### Model fit and residuals

The Figure `r run_reference("fig_indices_fit")` shows that the abundance indices from the acoustic surveys exhibit a high level of variability, as reflected by the width of the assumed confidence intervals, with a maximum coefficient of variation of 30%. The model follows the overall trend of the indices, though it encounters some difficulties in accurately fitting the extreme biomass values, both the highest and lowest. However, it adequately reproduces the general trend of variability in biomass levels presented by the survey estimates.


```{r}
include_graphics(file.path(path_mod,"fig_indices_fit.png"))
```

Figure `r run_bookmark("fig_indices_fit", figruns)`: ane.27.9a stock. Model fit to the data (left panel) and observed versus expected values (right panel) of the indices from the acoustic surveys *PELAGO*, *ECOCADIZ*, *BOCADEVA* and *ECOCADIZ-RECLUTAS*. The lines indicate a 95% uncertainty interval around the index values based on the lognormal error model assumption. 

\newpage

Figure `r run_reference("fig_runtest_residuals_indices")` shows that the residuals from the fit of the biomass indices are randomly distributed, with p-values greater than 0.05 (*PELAGO* = `r run_cpue[run_cpue$Index=="PELAGO","runs.p"]`, *ECOCADIZ* = `r run_cpue[run_cpue$Index=="ECOCADIZ","runs.p"]`, *BOCADEVA* = `r run_cpue[run_cpue$Index=="BOCADEVA","runs.p"]`, *ECOCADIZ-RECLUTAS* = `r run_cpue[run_cpue$Index=="ECORECLUTAS","runs.p"]`). The estimated root mean square error (RMSE) for the joint residual analysis is `r jaba_cpue[jaba_cpue$indices == "Combined", "RMSE.perc"]`%.


```{r}
include_graphics(file.path(path_mod,"fig_runtest_residuals_indices.png"))
```

Figure `r run_bookmark("fig_runtest_residuals_indices", figruns)`: ane.27.9a stock. Run test plots for the fit of acoustic survey indices. Green shading indicates no evidence (p>=0.05) and red shading indicates evidence (p<0.05) for rejecting the hypothesis of a randomly distributed residual time series, respectively. The shaded area (green/red) spans three standard residual deviations on either side of zero, and red points outside the shading violate the three-sigma limit for that series. The boxplot of joint residuals indicates the median and quantiles in cases where residuals from multiple indices are available for a given year, with the solid black line showing a loess smoother. The root mean square errors (RMSE) are included in the top right corner of the boxplot.

\newpage

Figure `r run_bookmark("fig_meanage_fit_EcocadizRecl", figruns)` shows the observed mean age in the catch data from the commercial fleet (SEINE) and in the surveys (*PELAGO*, *ECOCADIZ*, and *ECOCADIZ-RECLUTAS*), with 95% confidence intervals, along with the mean age fitted by the assessment model (SS3, blue line). Overall, the model adequately captures the general trend of the observed data, where the mean age fluctuates between 0 and 1.5 years, with variations across the different data sources.

In the case of the commercial fleet (*SEINE*), the model captures the observed fluctuations in the mean age, remaining around 1 year. For the *PELAGO* survey, the model follows the oscillation in the mean age, adjusting between 1 and 1.4 years, though it encounters some fitting issues in the later years of the series. In *ECOCADIZ*, the observed trend shows a progressive decline in mean age, starting near 1.0 and dropping below 0.5 in recent years, with the model struggling to fit this trend. Finally, in *ECOCADIZ-RECLUTAS*, the model fits well to an initial mean age below 0.5 years, increasing above 0.5 between 2016 and 2021, before decreasing again in the last two years of the series.


```{r fig.width=5, fig.height=6, dpi=300}

# Cargar las imágenes
img1 <- png::readPNG(file.path(path_mod,"fig_meanage_fit_Seine.png"))
img2 <- png::readPNG(file.path(path_mod,"fig_meanage_fit_Pelago.png"))
img3 <- png::readPNG(file.path(path_mod,"fig_meanage_fit_Ecocadiz.png"))
img4 <- png::readPNG(file.path(path_mod,"fig_meanage_fit_EcocadizRecl.png"))

# Convertir a grobs (graphic objects) para grid.arrange
g1 <- rasterGrob(img1, interpolate=TRUE)
g2 <- rasterGrob(img2, interpolate=TRUE)
g3 <- rasterGrob(img3, interpolate=TRUE)
g4 <- rasterGrob(img4, interpolate=TRUE)

# Organizar las imágenes en una cuadrícula
grid.arrange(g1, g2, g3, g4, ncol=1)

```

Figure `r run_bookmark("fig_meanage_fit_EcocadizRecl", figruns)`: Mean age for *PELAGO*, *ECOCADIZ*, and *ECOCADIZ-RECLUTAS* with 95% confidence intervals based on current sample sizes. Francis data weighting method TA1.8: thinner intervals (with capped ends) show the result of further adjusting sample sizes based on the suggested multiplier (with 95% interval) for age data. The blue line corresponds to the estimated mean age.

The Figure `r run_reference("fig_age_fit_agg")` shows the aggregated age compositions over time for different sources of catch: *SEINE*, *ECOCADIZ*, *PELAGO*, and *ECORECLUTAS*. Overall, a high proportion of young individuals (ages 0 and 1) is observed in both the commercial fleet catches and acoustic surveys, with a significant decline in the proportions of older age classes. The green lines represent the model fits, demonstrating an adequate fit, with the aggregated age compositions well reconstructed. 

```{r}
include_graphics(file.path(path_mod,"fig_age_fit_agg.png"))
```

Figure `r run_bookmark("fig_age_fit_agg", figruns)`: ane.27.9a stock. Model fit to the aggregated age composition data from the SEINE fishery, and the acoustic surveys *PELAGO*, *ECOCADIZ*, and *ECOCADIZ-RECLUTAS*. The green line represents the model estimates, while the shaded gray area shows the observed data.

\newpage

Although the aggregated fits show an overall adequate result, some years exhibit variability in the age composition of the commercial fleet (SEINE) catches, leading to reduced precision in the fits for the fourth quarter, particularly in 1991, 1996, and 2012 (Figure `r run_reference("fig_age_fit_Seine")`). This pattern is also evident in the annual data fits for the PELAGO survey, especially in the later years of the series (2020-2023), where there is a tendency to overestimate age 1 and underestimate age 2 (Figure `r run_reference("fig_age_fit_Pelago")`). In the ECOCADIZ survey, there are difficulties in estimating ages 0 and 1, with a tendency to underestimate age 0 and overestimate age 1 from 2016 to 2023 (Figure `r run_reference("fig_age_fit_Ecocadiz")`). In ECOCADIZ-RECLUTAS, a generally good fit is observed without a clear pattern of overestimation or underestimation (Figure `r run_reference("fig_age_fit_EcocadizRecl")`). These patterns are also reflected in the bubble plots of the residuals corresponding to the fit of these data (Figure `r run_reference("fig_comp_agefit_multi-fleet_comparison")`).


```{r}
include_graphics(file.path(path_mod,"fig_age_fit_Seine.png"))
```

Figure `r run_bookmark("fig_age_fit_Seine", figruns)`: ane.27.9a stock. Model fit to the age composition data from the *SEINE* fishery, by year and quarter. The green line represents the model estimates, while the shaded gray area shows the observed data.



```{r}
include_graphics(file.path(path_mod,"fig_age_fit_Pelago.png"))
```

Figure `r run_bookmark("fig_age_fit_Pelago", figruns)`: ane.27.9a stock. Model fit to the age composition data from the *PELAGO* spring survey by year. The green line represents the model estimates, while the shaded gray area shows the observed data.


```{r}
include_graphics(file.path(path_mod,"fig_age_fit_Ecocadiz.png"))
```

Figure `r run_bookmark("fig_age_fit_Ecocadiz", figruns)`: ane.27.9a stock. Model fit to the age composition data from the *ECOCADIZ* summer survey by year. The green line represents the model estimates, while the shaded gray area shows the observed data.


```{r}
include_graphics(file.path(path_mod,"fig_age_fit_EcocadizRecl.png"))
```

Figure `r run_bookmark("fig_age_fit_EcocadizRecl", figruns)`: ane.27.9a stock. Model fit to the age composition data from the *ECOCADIZ-RECLUTAS* fall survey by year. The green line represents the model estimates, while the shaded gray area shows the observed data.


```{r}
include_graphics(file.path(path_mod,"fig_comp_agefit_multi-fleet_comparison.png"))
```

Figure `r run_bookmark("fig_comp_agefit_multi-fleet_comparison", figruns)`: ane.27.9a stock.  Pearson residuals, comparing across fleets. Closed bubbles are positive residuals (observed > expected) and open negative residuals (observed < expected).

\newpage

The Figure `r run_reference("fig_runtest_residuals_age")` shows that the residuals from the fit of the age proportions are randomly distributed, with p-values greater than 0.05 in the case of the commercial fleet (*SEINE* = `r run_age[run_age$Index=="SEINE","runs.p"]`) and the acoustic surveys (*PELAGO* = `r run_age[run_age$Index=="PELAGO","runs.p"]`, *ECOCADIZ-RECLUTAS* = `r run_age[run_age$Index=="ECORECLUTAS","runs.p"]`). Some violations of the three-standard-deviation limit are observed for the commercial fleet (*SEINE*) during the fourth quarter of 1991, 1996, and 2012, as well as in the *PELAGO* survey in the last year of the series (2023). In the case of the *ECOCADIZ* survey, the residuals are not randomly distributed *ECOCADIZ* = `r run_age[run_age$Index=="ECOCADIZ","runs.p"]`, with several violations of the three-standard-deviation limit observed, primarily from 2018 to 2023. The estimated root mean square error (RMSE) for the joint residual analysis is `r jaba_age[jaba_age$indices == "Combined", "RMSE.perc"]`%.

```{r}
include_graphics(file.path(path_mod,"fig_runtest_residuals_age.png"))
```

Figure `r run_bookmark("fig_runtest_residuals_age", figruns)`: ane.27.9a stock. a) Runs test results for fits to annual mean age estimates for the surveys (*PELAGO*, *ECOCADIZ*, *ECOCADIZ-RECLUTAS*) and the fishery (*SEINE*). Green shaded (green/red) area spans three residual standard deviations to either side from zero, and the red points outside of the shading violate the 'three-sigma limit' for that series.  b) Joint residual plots for annual mean length estimates for surveys and fishery.  Vertical lines with points show the residuals, and solid black lines show loess smoother through all residuals. Boxplot indicate the median and quantiles in cases where residuals from the multiple indices are available for any given year. Root-mean squared errors (RMSE) are included in the upper right-hand corner of each plot.

\newpage

### Retrospective

Figure `r run_reference("Retro")` shows a retrospective pattern in both spawning biomass and fishing mortality in the base model. The retrospective analysis of the assessment model reveals that, in terms of Mohn's rho (mean of retrospective anomalies), the reduction in data leads to a pattern of underestimation in fishing mortality (rho = `r rho_f`) and overestimation in spawning biomass (rho = `r rho_ssb`). These values the Mohn´s rho  were inside the bounds of recommended values, according to the rule proposed by @HurtadoFerro2014, which states that Mohn's rho index values greater than 0.30 or less than -0.22 for short-lived species should be considered as indicators of concern when evaluating a retrospective pattern.

<!-- In general, the estimates of biomass and F for the most recent years can vary substantially between successive updates, while in the earlier years, they tend to converge to stable values. The model exhibits high statistical variance in the last years of the series, resulting in greater uncertainty for projections and generating unreliable estimates for establishing management measures. -->

```{r}
include_graphics(file.path(path_retro,"Retro.png"))
```

Figure `r run_bookmark("Retro", figruns)`: ane.27.9a stock. Retrospective analysis of spawning stock biomass (SSB) and fishing mortality (F). Models  conducted by re-fitting the reference model (Ref) after removing five years of observations, one year at a time sequentially. The retrospective results are shown the entire time series. Mohn's rho statistic and the corresponding 'hindcast rho' values (in brackets) are printed at the top of the panels. One-year-ahead projections denoted by color-coded dashed lines with terminal points are shown for each model. Gray shaded areas are the 95% confidence intervals from the reference model.

\newpage

## Time series

The Figure  `r run_reference("fig_time_series")` shows the  biomass shows variability around the historical mean of `r round(agg_Value2[agg_Value2$type == "Bt", "Value.mean", drop = TRUE] / 1000, 2)` thousand tonnes, with a minimum in `r agg_Value2[agg_Value2$type == "Bt", "year.min", drop = TRUE]` of `r round(agg_Value2[agg_Value2$type == "Bt", "Value.min", drop = TRUE] / 1000, 2)` thousand tonnes and a maximum recorded in `r agg_Value2[agg_Value2$type == "Bt", "year.max"]` of `r round(agg_Value2[agg_Value2$type == "Bt", "Value.max", drop = TRUE] / 1000, 2)` thousand tonnes. In 2023, the biomass is estimated to be `r round(1 - (data[data$type == "Bt" & data$year == 2023, "Value", drop = TRUE] / agg_Value2[agg_Value2$type == "Bt", "Value.mean", drop = TRUE]), 2) * 100`% below the historical mean. The catch shows variability around the historical mean of `r round(agg_Value2[agg_Value2$type == "Catch", "Value.mean", drop = TRUE] / 1000, 2)` thousand tonnes, with a maximum value recorded in `r agg_Value2[agg_Value2$type == "Catch", "year.max"]` of `r round(agg_Value2[agg_Value2$type == "Catch", "Value.max", drop = TRUE] / 1000, 2)` thousand tonnes and a minimum in `r agg_Value2[agg_Value2$type == "Catch", "year.min", drop = TRUE]` of `r round(agg_Value2[agg_Value2$type == "Catch", "Value.min", drop = TRUE] / 1000, 2)` thousand tonnes.  In 2023, the catch is estimated to be `r round( (data[data$type == "Catch" & data$year == 2023, "Value", drop = TRUE] / agg_Value2[agg_Value2$type == "Catch", "Value.mean", drop = TRUE])-1, 2) * 100`% above the historical mean. 

The fishing mortality (`Ft`) shows variability around the historical mean of `r round(agg_Value2[agg_Value2$type == "Ft", "Value.mean", drop = TRUE], 2)`, with a maximum value recorded in `r agg_Value2[agg_Value2$type == "Ft", "year.max"]` of `r round(agg_Value2[agg_Value2$type == "Ft", "Value.max", drop = TRUE], 2)` and a minimum in `r agg_Value2[agg_Value2$type == "Ft", "year.min", drop = TRUE]` of `r round(agg_Value2[agg_Value2$type == "Ft", "Value.min", drop = TRUE], 2)`. Confidence intervals range from `r round(agg_CV[agg_CV$type == "Ft", "Value.max", drop = TRUE], 2)` to `r round(agg_CV[agg_CV$type == "Ft", "Value.min", drop = TRUE], 2)`, with an average of `r round(agg_CV[agg_CV$type == "Ft", "Value.mean", drop = TRUE], 2)`.  In 2023, the `Ft` is estimated to be `r round( (data[data$type == "Ft" & data$year == 2023, "Value", drop = TRUE] / agg_Value2[agg_Value2$type == "Ft", "Value.mean", drop = TRUE])-1, 2) * 100`% above the historical mean. 

The recruitment (`Rt`) fluctuates around a historical mean of  `r round(agg_Value2[agg_Value2$type == "Rt", "Value.mean", drop = TRUE] / 1000000, 2)` millions recruits, with a maximum value recorded in `r agg_Value2[agg_Value2$type == "Rt", "year.max"]` of `r round(agg_Value2[agg_Value2$type == "Rt", "Value.max", drop = TRUE] / 1000000, 2)` millions recruits and a minimum in `r agg_Value2[agg_Value2$type == "Rt", "year.min", drop = TRUE]` of `r round(agg_Value2[agg_Value2$type == "Rt", "Value.min", drop = TRUE] / 1000000, 2)` millions recruits. Confidence intervals range from `r round(agg_CV[agg_CV$type == "Rt", "Value.max", drop = TRUE], 2)` to `r round(agg_CV[agg_CV$type == "Rt", "Value.min", drop = TRUE], 2)`, with an average of `r round(agg_CV[agg_CV$type == "Rt", "Value.mean", drop = TRUE], 2)`.  In 2023, the `Rt` is estimated to be `r round(1- (data[data$type == "Rt" & data$year == 2023, "Value", drop = TRUE] / agg_Value2[agg_Value2$type == "Rt", "Value.mean", drop = TRUE]), 2) * 100`% below the historical mean. 

Finally, the spawning biomass (SSB) varies around a historical mean of `r round(agg_Value2[agg_Value2$type == "SSB", "Value.mean", drop = TRUE] / 1000, 2)` thousand tonnes, with a maximum value recorded in `r agg_Value2[agg_Value2$type == "SSB", "year.max"]` of `r round(agg_Value2[agg_Value2$type == "SSB", "Value.max", drop = TRUE] / 1000, 2)` thousand tonnes and a minimum in `r agg_Value2[agg_Value2$type == "SSB", "year.min", drop = TRUE]` of `r round(agg_Value2[agg_Value2$type == "SSB", "Value.min", drop = TRUE] / 1000, 2)` thousand tonnes. Confidence intervals range from `r round(agg_CV[agg_CV$type == "SSB", "Value.max", drop = TRUE], 2)` to `r round(agg_CV[agg_CV$type == "SSB", "Value.min", drop = TRUE], 2)`, with an average of `r round(agg_CV[agg_CV$type == "SSB", "Value.mean", drop = TRUE], 2)`.In 2023, the `SSB` is estimated to be `r round(1- (data[data$type == "SSB" & data$year == 2023, "Value", drop = TRUE] / agg_Value2[agg_Value2$type == "SSB", "Value.mean", drop = TRUE]), 2) * 100`% below the historical mean. 

The summarised results of the stock assessment are shown in Table `r run_reference("tb_timeseries")`.

```{r}
include_graphics(file.path(path_mod,"fig_time_series.png"))
```

Figure `r run_bookmark("fig_time_series", figruns)`: ane.27.9a stock. Time series estimated by the model for annual catches (in tons), recruitment (millions of fish), total biomass and spawning biomass (in tons), and fishing mortality (year-1).

\newpage

Table `r run_bookmark("tb_timeseries", tabruns)`:  ane.27.9a stock. Time series estimated by the model for annual catches (in tons), recruitment (millions of fish), total biomass and spawning biomass (in tons), and fishing mortality (year-1).

```{r}
include_graphics(file.path(path_mod,"tb_timeseries.png"))
```

## Selectivity

Figure `r run_reference("fig_age_selectivity")` shows the estimated selectivity for the age composition of the commercial fleet and acoustic surveys (logistic-shaped fixed selectivity across all years).

```{r fig.width=7, fig.height=4, dpi=300}
# Cargar las imágenes
#img1 <- png::readPNG(file.path(path_mod,"fig_age_selectivity_var.png"))
img2 <- png::readPNG(file.path(path_mod,"fig_age_selectivity.png"))

# Convertir a grobs (graphic objects) para grid.arrange
#g1 <- rasterGrob(img1, interpolate=TRUE)
g2 <- rasterGrob(img2, interpolate=TRUE)

# Organizar las imágenes en una cuadrícula
grid.arrange(g2,  ncol=1)
```

Figure `r run_bookmark("fig_age_selectivity", figruns)`: ane.27.9a stock.Estimated selectivity for catch-at-age (logistic shaped fixed selectivity across all years).

## Catchability

The catchability (q) is adjusted to maintain a consistent relationship between the observed biomass and the vulnerable biomass in acoustic surveys. As vulnerable biomass decreases throughout the year, catchability increases, indicating that efforts intensify when the vulnerable biomass is lower (Figure  `r run_reference("fig_catchability")` ).

```{r}
include_graphics(file.path(path_mod,"fig_catchability.png"))
```

Figure `r run_bookmark("fig_catchability", figruns)`: ane.27.9a stock. Estimated catchability parameters for the different surveys indices.


\newpage

## Funding

The author(s) declare that financial support was received for the research, authorship of this document. This research has been developed in the framework of the Math4Fish project: New tools for mathematical modelling in Spanish fisheries scientific advice, financed by the European Union – NextGenerationEU, and the Recovery and Resilience Facility, Component 3, Investment 7 and has been carried out within the framework of the agreement between the Spanish Ministry of Agriculture, Fishing and Food and the Spanish National Research Council (CSIC) through the Spanish Institute of Oceanography (IEO) to promote fisheries research as a basis for sustainable fisheries management. Views and opinions expressed are however those of the author(s) only and do not necessarily reflect those of the European Union or European Commission. Neither the European Union nor the European Commission can be held responsible for them

## References
